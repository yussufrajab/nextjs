name: Load Testing

on:
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of load test to run'
        required: true
        type: choice
        options:
          - stress
          - auth
          - hr-workflows
          - file-operations
          - all
        default: 'stress'
      base_url:
        description: 'Base URL to test (leave empty for staging)'
        required: false
        type: string
        default: ''

  # Run on schedule (weekly)
  schedule:
    - cron: '0 2 * * 0' # Every Sunday at 2 AM UTC

  # Run on release
  release:
    types: [published]

jobs:
  load-test:
    name: Run Load Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Verify k6 installation
        run: k6 version

      - name: Set BASE_URL
        id: set-url
        run: |
          if [ -n "${{ github.event.inputs.base_url }}" ]; then
            echo "BASE_URL=${{ github.event.inputs.base_url }}" >> $GITHUB_ENV
          else
            echo "BASE_URL=https://staging.csms.gov.zz" >> $GITHUB_ENV
          fi

      - name: Run Stress Test
        if: github.event.inputs.test_type == 'stress' || github.event.inputs.test_type == 'all' || github.event_name == 'schedule' || github.event_name == 'release'
        run: |
          k6 run \
            --out json=load-tests/reports/stress-test-results.json \
            --summary-export=load-tests/reports/stress-test-summary.json \
            load-tests/stress-test.js
        env:
          BASE_URL: ${{ env.BASE_URL }}

      - name: Run Authentication Tests
        if: github.event.inputs.test_type == 'auth' || github.event.inputs.test_type == 'all'
        run: |
          k6 run \
            --out json=load-tests/reports/auth-results.json \
            load-tests/scenarios/auth.test.js
        env:
          BASE_URL: ${{ env.BASE_URL }}

      - name: Run HR Workflows Tests
        if: github.event.inputs.test_type == 'hr-workflows' || github.event.inputs.test_type == 'all'
        run: |
          k6 run \
            --out json=load-tests/reports/hr-workflows-results.json \
            load-tests/scenarios/hr-workflows.test.js
        env:
          BASE_URL: ${{ env.BASE_URL }}

      - name: Run File Operations Tests
        if: github.event.inputs.test_type == 'file-operations' || github.event.inputs.test_type == 'all'
        run: |
          k6 run \
            --out json=load-tests/reports/file-operations-results.json \
            load-tests/scenarios/file-operations.test.js
        env:
          BASE_URL: ${{ env.BASE_URL }}

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: load-test-reports
          path: load-tests/reports/
          retention-days: 30

      - name: Check test thresholds
        if: always()
        run: |
          # This step will fail if any k6 test failed its thresholds
          if grep -q '"pass":false' load-tests/reports/*.json; then
            echo "::error::Load test thresholds were not met"
            exit 1
          fi

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summaryPath = 'load-tests/reports/stress-test-summary.json';

            if (fs.existsSync(summaryPath)) {
              const summary = JSON.parse(fs.readFileSync(summaryPath, 'utf8'));

              const comment = `## Load Test Results

              **Test Type:** ${{ github.event.inputs.test_type || 'stress' }}
              **Target URL:** ${process.env.BASE_URL}

              ### Metrics
              - **HTTP Request Duration (p95):** ${summary.metrics?.http_req_duration?.values?.['p(95)']?.toFixed(2)}ms
              - **Request Failure Rate:** ${(summary.metrics?.http_req_failed?.values?.rate * 100)?.toFixed(2)}%
              - **Checks Pass Rate:** ${(summary.metrics?.checks?.values?.rate * 100)?.toFixed(2)}%

              ### Virtual Users
              - **Max VUs:** ${summary.metrics?.vus_max?.values?.max}

              [View detailed reports in artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  notify-failure:
    name: Notify on Failure
    needs: load-test
    if: failure() && (github.event_name == 'schedule' || github.event_name == 'release')
    runs-on: ubuntu-latest

    steps:
      - name: Send notification
        run: |
          echo "::error::Load test failed. Please check the test results."
          # Add your notification mechanism here (e.g., Slack, email, etc.)
